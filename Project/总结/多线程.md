# ğŸˆğŸˆå¤šçº¿ç¨‹

# 1 çº¿ç¨‹ã€è¿›ç¨‹

## 1.1 æ¦‚å¿µ

è¯´åˆ°å¤šçº¿ç¨‹ï¼Œæˆ‘ä»¬é¦–å…ˆè¦äº†è§£ä¸‹çº¿ç¨‹å’Œè¿›ç¨‹

- **Process è¿›ç¨‹**ï¼šä¸€ä¸ªåœ¨å†…å­˜ä¸­è¿è¡Œçš„åº”ç”¨ç¨‹åºã€‚æ¯ä¸ªè¿›ç¨‹éƒ½æœ‰è‡ªå·±ç‹¬ç«‹çš„ä¸€å—å†…å­˜ç©ºé—´ï¼Œä¸€ä¸ªè¿›ç¨‹å¯ä»¥æœ‰å¤šä¸ªçº¿ç¨‹
- **Thread çº¿ç¨‹**ï¼šå°±æ˜¯è¿›ç¨‹ä¸­çš„ä¸€ä¸ªç‹¬ç«‹æ§åˆ¶å•å…ƒï¼Œçº¿ç¨‹åœ¨æ§åˆ¶ç€è¿›ç¨‹çš„æ‰§è¡Œã€‚å› ä¸ºç³»ç»Ÿäº§ç”Ÿä¸€ä¸ªçº¿ç¨‹æˆ–æ˜¯åœ¨å„ä¸ªçº¿ç¨‹ä¹‹é—´ä½œåˆ‡æ¢å·¥ä½œæ—¶ï¼Œè´Ÿæ‹…è¦æ¯”è¿›ç¨‹å°å¾—å¤šï¼Œä¹Ÿæ­£å› ä¸ºå¦‚æ­¤ï¼Œæˆ‘ä»¬ä¹Ÿå«å®ƒâ€œè½»é‡çº§çº¿ç¨‹â€ã€‚

> è¯´å®Œæ¦‚å¿µï¼Œæˆ‘å°±æƒ³åˆ°ä¸¤è€…çš„åŒºåˆ«ï¼ˆå­¦æ ¡è€ƒè¯•è€ƒè¿‡å‡ æ¬¡è¿™ç§æ¦‚å¿µï¼‰è¿›ç¨‹æ˜¯ç³»ç»Ÿèµ„æºåˆ†é…çš„åŸºæœ¬å•ä½ï¼Œçº¿ç¨‹æ˜¯cpuè°ƒåº¦å’Œåˆ†é…çš„åŸºæœ¬å•ä½




- **é—®é¢˜**ï¼šåˆ†æå®ŒåŒºåˆ«ï¼Œå°±æœ‰ä¸€ä¸ªç–‘é—®äº†ï¼Œå¤šçº¿ç¨‹ä¸ºäº†ä»€ä¹ˆï¼Œæ˜¯ä¸ºäº†å……åˆ†åˆ©ç”¨cpuæ‰§è¡Œä»»åŠ¡å—ï¼Ÿ

å¯¹å•Šï¼Œé‡ç‚¹æ¥äº†ï¼Œ**çº¿ç¨‹æ˜¯cpuè°ƒåº¦å’Œåˆ†é…çš„åŸºæœ¬å•ä½**ï¼Œè¿½æ ¹åˆ°åº•ï¼Œä¸ºäº†æ›´å¥½çš„åˆ©ç”¨cpuçš„èµ„æºï¼Œæˆ‘ä»¬å°±è¦ä½¿ç”¨å¤šçº¿ç¨‹æ¥åŠ å¿«å®Œæˆä»»åŠ¡ï¼Œå¦‚æœåªæœ‰ä¸€ä¸ªçº¿ç¨‹ï¼Œåˆ™ç¬¬äºŒä¸ªä»»åŠ¡å¿…é¡»ç­‰åˆ°ç¬¬ä¸€ä¸ªä»»åŠ¡ç»“æŸåæ‰èƒ½è¿›è¡Œï¼Œå¦‚æœä½¿ç”¨å¤šçº¿ç¨‹åˆ™åœ¨ä¸»çº¿ç¨‹æ‰§è¡Œä»»åŠ¡çš„åŒæ—¶å¯ä»¥æ‰§è¡Œå…¶ä»–ä»»åŠ¡ï¼Œè€Œä¸éœ€è¦ç­‰å¾…ã€‚

## 1.2 ç”Ÿå‘½å‘¨æœŸ

æ¥ç€ä¸Šé¢è¯´ï¼Œæ‰§è¡Œä»»åŠ¡ï¼Œä»€ä¹ˆæ—¶å€™ç®—ä»»åŠ¡å¼€å§‹æ‰§è¡Œï¼Œå•¥æ—¶å€™ç®—ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ï¼Œé‡Šæ”¾èµ„æºç»™ä¸‹ä¸€ä¸ªä»»åŠ¡ï¼Œå°±ç‰µæ‰¯åˆ°äº†çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸé—®é¢˜

- çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸ

  - åˆ›å»º ï¼šä»æ–°å»ºä¸€ä¸ªçº¿ç¨‹å¯¹è±¡åˆ°ç¨‹åºstart() è¿™ä¸ªçº¿ç¨‹ä¹‹é—´çš„çŠ¶æ€ï¼Œéƒ½æ˜¯æ–°å»ºçŠ¶æ€

  - å°±ç»ª ï¼šçº¿ç¨‹å¯¹è±¡è°ƒç”¨start()æ–¹æ³•åï¼Œå°±å¤„äºå°±ç»ªçŠ¶æ€ï¼Œç­‰åˆ°JVMé‡Œçš„çº¿ç¨‹è°ƒåº¦å™¨çš„è°ƒåº¦
  - è¿è¡Œ ï¼šå°±ç»ªçŠ¶æ€ä¸‹çš„çº¿ç¨‹åœ¨è·å–CPUèµ„æºåå°±å¯ä»¥æ‰§è¡Œrun(),æ­¤æ—¶çš„çº¿ç¨‹ä¾¿å¤„äºè¿è¡ŒçŠ¶æ€
  - é˜»å¡ï¼šåœ¨ä¸€ä¸ªçº¿ç¨‹æ‰§è¡Œäº†sleepï¼ˆç¡çœ ï¼‰ã€suspendï¼ˆæŒ‚èµ·ï¼‰ç­‰æ–¹æ³•åä¼šå¤±å»æ‰€å æœ‰çš„èµ„æºï¼Œä»è€Œè¿›å…¥é˜»å¡çŠ¶æ€ï¼Œåœ¨ç¡çœ ç»“æŸåå¯é‡æ–°è¿›å…¥å°±ç»ªçŠ¶æ€
  - ç»ˆæ­¢ï¼ˆæ­»äº¡ï¼‰ ï¼šrunï¼ˆï¼‰æ–¹æ³•å®Œæˆåæˆ–å‘ç”Ÿå…¶ä»–ç»ˆæ­¢æ¡ä»¶æ—¶å°±ä¼šåˆ‡æ¢åˆ°ç»ˆæ­¢çŠ¶æ€ã€‚



# 2 åˆ›å»ºçº¿ç¨‹

çº¿ç¨‹çš„çŸ¥è¯†äº†è§£åï¼Œå¿ä¸ä½å¼€å§‹ä½¿ç”¨ä»–äº†ï¼Œè¿™ä¹Ÿæ˜¯é‡ç‚¹ï¼Œ

questionï¼šé¢è¯•æ—¶å¤šçº¿ç¨‹ç¬¬ä¸€ä¸ªé—®é¢˜å°±æ˜¯è¿™ä¸ªï¼Œä½ è¯´ä¸€è¯´çº¿ç¨‹çš„åˆ›å»ºæ–¹å¼

- å¸¸è§æ–¹å¼ï¼š**ç»§æ‰¿Threadç±»ï¼Œå®ç°Runnableæ¥å£ï¼Œé€šè¿‡Callableå’ŒFutureåˆ›å»ºçº¿ç¨‹**

- æ‰©å……ï¼š**åŒ¿åå†…éƒ¨ç±»ï¼ŒCompletableFutureï¼Œçº¿ç¨‹æ± **

- å…ˆä¸Š**æ€»ç»“**

| åˆ›å»ºæ–¹å¼                     | åŒºåˆ«                                                         |
| ---------------------------- | ------------------------------------------------------------ |
| ç»§æ‰¿Threadç±»                 | é‡å†™runæ–¹æ³•ï¼Œé€šè¿‡startå¯åŠ¨çº¿ç¨‹(å› ä¸ºJavaæ˜¯å•æ ¹ç»§æ‰¿ç»“æ„ï¼Œæ‰€ä»¥ä¸€ä¸ªç±»æ˜¯çº¿ç¨‹ç±»ï¼Œå°±ä¸èƒ½æ˜¯å…¶å®ƒç±»å‹çš„å­ç±»å‹äº†ï¼Œæœ‰å±€é™æ€§) |
| å®ç°Runnableæ¥å£             | å®ç°runæ–¹æ³•ï¼Œé€šè¿‡startå¯åŠ¨çº¿ç¨‹ï¼ˆå› ä¸ºTaskç±»åªéœ€è¦å®ç°æ¥å£ï¼Œæ‰€ä»¥å®ƒå¯ä»¥æ˜¯å…¶å®ƒç±»çš„å­ç±»å‹ï¼Œæ›´çµæ´»ï¼‰ |
| é€šè¿‡Callableå’ŒFutureåˆ›å»ºçº¿ç¨‹ | è·ŸRunableç›¸æ¯”ï¼Œæœ‰è¿”å›å€¼ï¼Œè€Œä¸”Callableæœ‰å¼‚å¸¸å¤„ç†ï¼Œå¹¶ä¸”è·å–å¼‚å¸¸ |
| åŒ¿åå†…éƒ¨ç±»                   | æ›´åŠ çµæ´»ï¼Œå¯ä»¥ä¸ç”¨å†åˆ»æ„çš„æ–°å»ºä¸€ä¸ªç±»ï¼Œå®ƒçš„å”¯ä¸€çš„ç¡®å®šï¼Œå°±æ˜¯åˆ«äººæ— æ³•é‡ç”¨ï¼ˆå®ƒæ²¡æœ‰åç§°ï¼‰ |
| çº¿ç¨‹æ±                        | åŸå§‹çš„çº¿ç¨‹åˆ›å»ºæ–¹å¼ä¼šé¢‘ç¹çš„åˆ›å»ºé”€æ¯çº¿ç¨‹ï¼Œè€—è´¹èµ„æºï¼Œçº¿ç¨‹æ± ç»™ä½ åˆ›å»ºå‡ºæ¥ç»Ÿä¸€ç®¡ç†ï¼Œæé«˜å“åº”é€Ÿåº¦ï¼Œä»»åŠ¡ä¸éœ€è¦ç­‰å¾…ï¼Œå³åˆ°å³ç”¨ |
| CompletableFutureï¼ˆJDK8ï¼‰    | xxxxAsync()æ–¹æ³•è¡¨ç¤ºå¼‚æ­¥ï¼ˆAsyncï¼šå¼‚æ­¥ï¼‰ï¼Œåœ¨çº¿ç¨‹æ± ä¸­æ‰§è¡Œï¼Œå®ç°äº†Futureæ¥å£ï¼ˆå¯ä»¥è·å¾—è¿”å›å€¼ï¼‰ï¼Œå¹¶åœ¨æ­¤åŸºç¡€ä¸Šè¿›è¡Œäº†æ‰©å±•ï¼Œå®ç°äº†å¯¹ä»»åŠ¡ç¼–æ’çš„èƒ½åŠ› |



ä¸‹é¢ç®€å•ä»‹ç»ä¸‹ï¼ˆå¥½åƒå…¨æ˜¯ä»£ç ğŸ¤¬ï¼Œæ‡‚åˆ›å»ºå°±æ²¡å¿…è¦çœ‹ä»£ç ï¼ˆåˆ æ‰éƒ½è¡Œï¼‰ï¼Œçœ‹åŒºåˆ«ï¼Œé¢è¯•çš„æ—¶å€™å°±å¯ä»¥è¯´è¯´ä¸Šé¢çš„åŒºåˆ«ï¼‰

## 2.1 ç¼–å†™Threadçš„å­ç±»

~~~java
// ç¼–å†™ä¸€ä¸ªçº¿ç¨‹ç±»çš„å­ç±»
  class MyThread extends Thread {  
      @Override
      public void run() {
          RandomUtils.longSleep(3000, 5000);
          // è·å–åˆ°å½“å‰çš„çº¿ç¨‹å¯¹è±¡
          Thread thread = Thread.currentThread();
          String name = thread.getName();
          long id = thread.getId();
          int priority = thread.getPriority(); // çº¿ç¨‹çš„ä¼˜å…ˆçº§
          System.out.println(name + ":" + id + ":" + priority);
          System.out.println(thread.getId() + "æ‰§è¡Œå®Œæ¯•");
      }
  }
~~~

## 2.2 ç¼–å†™ç±»å®ç°Runnableæ¥å£

~~~java
class Task implements Runnable {
    @Override
    public void run() {
        RandomUtils.longSleep(3000, 5000);
        // è·å–åˆ°å½“å‰çš„çº¿ç¨‹å¯¹è±¡
        Thread thread = Thread.currentThread();
        String name = thread.getName();
        long id = thread.getId();
        int priority = thread.getPriority(); // çº¿ç¨‹çš„ä¼˜å…ˆçº§
        System.out.println(name + ":" + id + ":" + priority);
        System.out.println(thread.getId() + "æ‰§è¡Œå®Œæ¯•");
    }
}
~~~

## 2.3 é€šè¿‡Callableå’ŒFutureåˆ›å»ºçº¿ç¨‹

~~~java
public class CallableFutrueTest {
    public static void main(String[] args) {
        CallableTest ct = new CallableTest();                        
        FutureTask<Integer> ft = new FutureTask<Integer>(ct);//ä½¿ç”¨FutureTaskåŒ…è£…CallableTestå¯¹è±¡
        for(int i = 0; i < 100; i++){
            System.out.println(Thread.currentThread().getName() + "ä¸»çº¿ç¨‹çš„iä¸ºï¼š" + i);
            //å½“ä¸»çº¿ç¨‹æ‰§è¡Œç¬¬30æ¬¡ä¹‹åå¼€å¯å­çº¿ç¨‹
            if(i == 30){
                Thread td = new Thread(ft,"å­çº¿ç¨‹");
                td.start();
            }
        }     
        try { //è·å–å¹¶è¾“å‡ºå­çº¿ç¨‹call()æ–¹æ³•çš„è¿”å›å€¼
            System.out.println("å­çº¿ç¨‹çš„è¿”å›å€¼ä¸º" + ft.get());
        } catch (InterruptedException e) {
            e.printStackTrace();
        } catch (ExecutionException e) {
            e.printStackTrace();
        }
    }
}
class CallableTest implements Callable<Integer>{
    //å¤å†™call() æ–¹æ³•ï¼Œcall()æ–¹æ³•å…·æœ‰è¿”å›å€¼
    public Integer call() throws Exception {
        int i = 0;
        for( ; i<100; i++){
            System.out.println(Thread.currentThread().getName() + "çš„å˜é‡å€¼ä¸ºï¼š" + i);
        }
        return i;
    }
}
~~~

## 2.4 åŒ¿åå†…éƒ¨ç±»

~~~java
private static void multiThreadDemo() {
        // æ‰“å°å½“å‰ä¸»çº¿ç¨‹çš„ä¿¡æ¯
        Thread main = Thread.currentThread (); // å¯ä»¥ç†è§£ä¸ºä¸»çº¿ç¨‹
        System.out.println(main.getId() + ":" + main.getName());
        // å®ä¾‹åŒ–ä¸€ä¸ªçº¿ç¨‹å¯¹è±¡
        for (int i = 0; i < 3; i++) { // åˆ›å»º3ä¸ªå­çº¿ç¨‹
            Thread t = new Thread(() -> { // åŒ¿åå†…éƒ¨ç±» - ç®€åŒ–ä¸ºlambdaè¡¨è¾¾å¼
                RandomUtils.longSleep(3000, 5000);
                // è·å–åˆ°å½“å‰çš„çº¿ç¨‹å¯¹è±¡
                Thread thread = Thread.currentThread();
                String name = thread.getName();
                long id = thread.getId();
                int priority = thread.getPriority(); // çº¿ç¨‹çš„ä¼˜å…ˆçº§
                System.out.println(name + ":" + id + ":" + priority);
                System.out.println(thread.getId() + "æ‰§è¡Œå®Œæ¯•");
            });
            t.start();
        }
        System.out.println("-----------------------------");
    }
~~~

# 3 çº¿ç¨‹æ± 

è¿™ä¸ªå¬èµ·æ¥å°±é«˜å¤§å°šï¼Œæ‹¿å‡ºæ¥å•ç‹¬è®²å§

- **çº¿ç¨‹æ± åˆ›å»ºæ–¹å¼**
  - ä½¿ç”¨ Executors æ‰§è¡Œå™¨è‡ªåŠ¨åˆ›å»ºçº¿ç¨‹æ± 
  - æ‰‹åŠ¨ä½¿ç”¨ ThreadPoolExecutor åˆ›å»ºçº¿ç¨‹æ± ï¼ˆè¿™ä¸ªè¢«é¢è¯•å®˜é—®åˆ°äº†å‚æ•°ï¼‰

## 3.1 Executors æ‰§è¡Œå™¨è‡ªåŠ¨åˆ›å»ºçº¿ç¨‹æ± 

æœ‰å…­ç§ğŸ¤£ä»‹ç»å‡ ä¸ªä½ å¸¸ç”¨çš„å°±è¡Œ

è€è§„çŸ©å…ˆä¸Š**æ€»ç»“**ï¼Œçœç•¥Executors.

- **æ€»ç»“**

| çº¿ç¨‹æ±                            | ç‰¹ç‚¹                                                         |
| -------------------------------- | ------------------------------------------------------------ |
| newFixedThreadPool               | åˆ›å»ºâ¼€ä¸ªå›ºå®šâ¼¤â¼©çš„çº¿ç¨‹æ± ï¼Œå¯æ§åˆ¶å¹¶å‘çš„çº¿ç¨‹æ•°ï¼Œè¶…å‡ºçš„çº¿ç¨‹ä¼šåœ¨é˜Ÿåˆ—ä¸­ç­‰å¾… |
| newCachedThreadPool              | åˆ›å»ºâ¼€ä¸ªå¯ç¼“å­˜çš„çº¿ç¨‹æ± ï¼Œè‹¥çº¿ç¨‹æ•°è¶…è¿‡å¤„ç†æ‰€éœ€ï¼Œç¼“å­˜â¼€æ®µæ—¶é—´åä¼šå›æ”¶ï¼Œè‹¥çº¿ç¨‹æ•°ä¸å¤Ÿï¼Œåˆ™æ–°å»ºçº¿ç¨‹ |
| newSingleThreadExecutor          | åˆ›å»ºå•ä¸ªçº¿ç¨‹æ•°çš„çº¿ç¨‹æ± ï¼Œå®ƒå¯ä»¥ä¿è¯å…ˆè¿›å…ˆå‡ºçš„æ‰§â¾é¡ºåº         |
| newScheduledThreadPool           | åˆ›å»ºâ¼€ä¸ªå¯ä»¥æ‰§â¾å»¶è¿Ÿä»»åŠ¡çš„çº¿ç¨‹æ±                              |
| newSingleThreadScheduledExecutor | åˆ›å»ºâ¼€ä¸ªå•çº¿ç¨‹çš„å¯ä»¥æ‰§â¾å»¶è¿Ÿä»»åŠ¡çš„çº¿ç¨‹æ±                      |
| newWorkStealingPoolï¼ˆJDK8ï¼‰      | åˆ›å»ºâ¼€ä¸ªæŠ¢å å¼æ‰§â¾çš„çº¿ç¨‹æ± ï¼ˆä»»åŠ¡æ‰§â¾é¡ºåºä¸ç¡®å®šï¼‰             |

æœ‰å…´è¶£å¯ä»¥çœ‹çœ‹ä¸‹é¢ä»‹ç»ä¸‹ä¸Šè¯¾ç”¨è¿‡çš„å‡ ç§

### 3.1.1 å›ºå®šæ•°é‡çº¿ç¨‹æ± FixedThreadPool

åˆ›å»ºä¸€ä¸ªæœ‰å›ºå®šçº¿ç¨‹æ•°é‡çš„çº¿ç¨‹æ±  N-1 æ¨¡å¼ ä¸ªåˆ«ç»„ä»¶ä¼šç”¨N + 1,éå¸¸é€‚åˆä¿å®ˆçš„æ¥é™å®šå¯¹äºæœåŠ¡å™¨CPUèµ„æºçš„ä½¿ç”¨

~~~java
 public static void main(String[] args) {
        ExecutorService pool = Executors.newFixedThreadPool(Runtime.getRuntime().availableProcessors() - 1);
        // è¯·è€ƒè™‘å¦‚ä¸‹è¿™ç§æƒ…å†µï¼šå‰é¢3ä¸ªä»»åŠ¡çš„æ‰§è¡Œæ—¶é—´éå¸¸é•¿ï¼Œè€Œåé¢æäº¤çš„2ä¸ªä»»åŠ¡ä¼šæœ‰ä¸€ä¸ªç­‰å¾…æœŸ
        for (int i = 0; i < 100; i++) {
            pool.submit(() -> { // å¼€å‘äººå‘˜ä¸éœ€è¦è‡ªå·±æ¥åˆ›å»ºçº¿ç¨‹å¯¹è±¡ï¼Œè€Œæ˜¯æŠŠå…³æ³¨ç‚¹æ”¾åœ¨runï¼Œä¹Ÿå°±æ˜¯å…·ä½“çš„ä¸šåŠ¡é€»è¾‘
                RandomUtils.longSleep(1000, 5000);
                System.out.println(Thread.currentThread().getName());
            });
        }
        pool.shutdown(); // ç±»ä¼¼äºå„ç§joinï¼Œå³æ˜¯ä¼šç­‰åˆ°æ‰€æœ‰æäº¤çš„ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ä»¥åï¼Œå†å…³é—­pool
    }
~~~

### 3.1.2 æ‡’æ±‰æ¨¡å¼çº¿ç¨‹æ± CachedThreadPool

- æ‡’æ±‰
  ä¸€å¼€å§‹ï¼Œpoolçš„sizeä¸º0ï¼Œéšç€æäº¤ä»»åŠ¡çš„å¢å¤šï¼Œå®ƒä¼šä¸æ–­åˆ›å»ºæ–°çš„çº¿ç¨‹å®ä¾‹ï¼Œéšç€æ—¶é—´çš„æ¨è¿›ï¼Œæœ‰çš„ä»»åŠ¡å¾ˆå¿«å°±æ‰§è¡Œå®Œäº†ï¼Œçº¿ç¨‹å¯¹è±¡ä¼šæœ‰éƒ¨åˆ†é—²ç½®ï¼Œå› æ­¤å®ƒä»¬ä¼šè¢«poolé”€æ¯(å›æ”¶)ï¼Œå®ç°poolçš„sizeå‡ºç°å¼¹æ€§å¢é•¿å’Œæ”¶ç¼©
- é€‚ç”¨äºæäº¤è¯·æ±‚çš„é¢‘ç‡ä¸æ˜¯ç‰¹åˆ«å¿«ï¼Œä¹Ÿä¸æ˜¯ç‰¹åˆ«å¤šçš„åœºæ™¯

```java
public class Main {
    public static void main(String[] args) {
        ExecutorService pool = Executors.newCachedThreadPool();      
        for (int i = 0; i < 100; i++) {
            pool.submit(() -> { 
                RandomUtils.longSleep(1000, 5000);
                System.out.println(Thread.currentThread().getName());
            });
        }
        pool.shutdown(); // ä¼šç­‰åˆ°æ‰€æœ‰æäº¤çš„ä»»åŠ¡æäº¤ä»¥åï¼Œå†å…³é—­pool
        // pool.shutdownNow();
        // shutdownä»¥åï¼Œä¸å¯ä»¥å†æäº¤æ–°çš„ä»»åŠ¡äº†
    }
}
```

### 3.1.3 å®šæ—¶ä»»åŠ¡ScheduledThreadPool

- **scheduleAtFixedRate**ï¼šä¿éšœ2ä¸ªä»»åŠ¡çš„å¼€å§‹æ—¶é—´é—´éš”ä¸º1sï¼Œä½†æ˜¯å¦‚æœæœ‰ä¸€ä¸ªä»»åŠ¡çš„æ‰§è¡Œæ—¶é—´è¶…å‡º1sï¼Œé‚£ä¹ˆä¸‹ä¸€ä¸ªä»»åŠ¡çš„å¼€å§‹æ—¶é—´å°†ä¼šå»¶è¿Ÿåˆ°ä¸Šä¸€ä¸ªä»»åŠ¡ç»“æŸ

```java
public class ScheduleMain {
    public static void main(String[] args) {
        int poolSize = Runtime.getRuntime().availableProcessors() - 1;
        ScheduledExecutorService pool = Executors.newScheduledThreadPool(poolSize);
        
        //å‚æ•°1è¡¨ç¤ºRunableï¼Œé‡å†™æ–¹æ³•ï¼Œå‚æ•°2è¡¨ç¤ºç¬¬ä¸€ä¸ªå¼€å§‹ç­‰å¾…æ—¶é—´ï¼Œå‚æ•°3è¡¨ç¤º2ä¸ªä»»åŠ¡çš„å¼€å§‹æ—¶é—´é—´éš”ï¼Œå‚æ•°4è¡¨ç¤ºæ—¶é—´å•ä½
        
        pool.scheduleAtFixedRate(
                () -> {
                    System.out.println(">>>" + Thread.currentThread().getName());
                    RandomUtils.longSleep(3000, 5000);
                    System.out.println("<<<" + Thread.currentThread().getName());
                }, // ä»»åŠ¡å¹¶éæ˜¯é©¬ä¸Šæäº¤
                3,
                6,
                TimeUnit.SECONDS
        );      
```

- **scheduleWithFixedDelay**: ä¸¥æ ¼ä¿éšœä¸Šä¸€ä¸ªä»»åŠ¡ç»“æŸå’Œä¸‹ä¸€ä¸ªä»»åŠ¡å¼€å§‹ä¹‹é—´çš„é—´éš”ä¸€å®šæ˜¯1s

~~~java
public static void main(String[] args) {
    
    //å‚æ•°1è¡¨ç¤ºç¬¬ä¸€ä¸ªå‚æ•°è¡¨ç¤ºRunableï¼Œé‡å†™æ–¹æ³•ï¼Œå‚æ•°2è¡¨ç¤ºç¬¬ä¸€ä¸ªå¼€å§‹ç­‰å¾…æ—¶é—´ï¼Œå‚æ•°3è¡¨ç¤ºä¸Šä¸€ä¸ªä»»åŠ¡ç»“æŸå’Œä¸‹ä¸€ä¸ªä»»åŠ¡å¼€å§‹ä¹‹é—´çš„é—´éš”ï¼Œå‚æ•°4è¡¨ç¤ºæ—¶é—´å•ä½
    
				pool.scheduleWithFixedDelay(() -> {
                    System.out.println(">>>" + Thread.currentThread().getName());
                    RandomUtils.longSleep(3000, 5000);
                    System.out.println("<<<" + Thread.currentThread().getName());
                }, // ä»»åŠ¡å¹¶éæ˜¯é©¬ä¸Šæäº¤
                3,
                1,
                TimeUnit.SECONDS);
        RandomUtils.longSleep(60000);
        pool.shutdown();
    }
}
~~~

## 3.2  ThreadPoolExecutor æ‰‹åŠ¨åˆ›å»ºçº¿ç¨‹æ± 

é¢è¯•å®˜ä¸€å¬æˆ‘è¯´å®Œçº¿ç¨‹æ± ï¼Œå°±é—®æˆ‘ä½ ç”¨è¿‡çº¿ç¨‹æ± çš„å“ªäº›å‚æ•°ï¼Œä¼°è®¡æ˜¯æƒ³æ‘¸åº•ä¸‹æˆ‘å¹³å¸¸å­¦ä¹ çš„æ·±åº¦

- **çº¿ç¨‹æ± å‚æ•°**

| å‚æ•°                     | ä»‹ç»                                               |
| ------------------------ | -------------------------------------------------- |
| corePoolSize             | æ ¸å¿ƒçº¿ç¨‹æ± å¤§å°                                     |
| maximumPoolSize          | æœ€å¤§çº¿ç¨‹æ± å¤§å°                                     |
| keepAliveTime            | çº¿ç¨‹æ± ä¸­è¶…è¿‡corePoolSizeæ•°ç›®çš„ç©ºé—²çº¿ç¨‹æœ€å¤§å­˜æ´»æ—¶é—´ |
| workQueue                | é˜»å¡ä»»åŠ¡é˜Ÿåˆ—                                       |
| threadFactory            | æ–°å»ºçº¿ç¨‹å·¥å‚                                       |
| RejectedExecutionHandler | æ‹’ç»ç­–ç•¥                                           |

- corePoolSizeï¼ŒmaximumPoolSizeï¼ŒworkQueueä¹‹é—´å…³ç³»

ä¸Šå›¾ä¸Šå›¾

![image-20220928204721573](images/image-20220928204721573.png)ï¼ˆ**corePoolSizeï¼ŒmaximumPoolSizeï¼ŒworkQueueä¹‹é—´å…³ç³»**)

è¿™ä¸‰ä¸ªå‚æ•°å¯ä»¥æ‹¿å‡ºæ¥å¯¹ç€å›¾è®²ä¸€è®²ï¼Œå¦‚æœçº¿ç¨‹æ± çº¿ç¨‹æ•°å°äºæ ¸å¿ƒçº¿ç¨‹æ± å¤§å°ï¼Œé‚£ä¹ˆæäº¤æ–°ä»»åŠ¡æ—¶ä¼šåˆ›å»ºä¸€ä¸ªæ–°çº¿ç¨‹å»æ‰§è¡Œï¼Œå³ä½¿æœ‰ç©ºé—²çº¿ç¨‹ï¼›å½“çº¿ç¨‹æ•°è¾¾åˆ°æ ¸å¿ƒçº¿ç¨‹æ± å¤§å°æ—¶ï¼Œæ–°ä»»åŠ¡ä¼šè¢«æ”¾å…¥é˜»å¡é˜Ÿåˆ—ï¼Œç­‰å¾…è°ƒåº¦ï¼Œå¦‚æœé˜»å¡é˜Ÿåˆ—æ»¡äº†ï¼Œè€Œä¸”æœ€å¤§çº¿ç¨‹æ± å¤§å°æ¯”æ ¸å¿ƒçº¿ç¨‹æ± å¤§å°å¤§ï¼Œæ–°æäº¤ä»»åŠ¡å°±ä¼šåˆ›å»ºæ–°çº¿ç¨‹æ‰§è¡Œä»»åŠ¡ï¼Œå†å¢åŠ ä»»åŠ¡æäº¤æ•°é‡ï¼Œè¶…è¿‡æœ€å¤§çº¿ç¨‹æ•°ï¼Œæ–°æäº¤çš„ä»»åŠ¡è¢«æ‹’ç»ç­–ç•¥å¤„ç†



# 4 API

å½“ä½ ç»†å¿ƒçœ‹å®Œçº¿ç¨‹çš„åˆ›å»ºåï¼Œè¯´æ˜ä½ æ˜¯ä¸€ä¸ªæœ‰è€å¿ƒçš„äººï¼Œè¿™ä¹ˆå¤šä¹Ÿèƒ½çœ‹ä¸‹å»ï¼Œç›¸ä¿¡ä½ åœ¨é¢è¯•ä¹Ÿèƒ½å¾ˆå¥½åœ°è®²å‡ºæ¥

å›é¡¾çº¿ç¨‹åˆè¡·ï¼Œæ˜¯ä¸ºäº†å……åˆ†åˆ©ç”¨cpuæ‰§è¡Œä»»åŠ¡ï¼Œä½†çº¿ç¨‹æ˜¯æœ‰é™çš„ï¼Œå› æ­¤æˆ‘ä»¬è¦åˆç†ä½¿ç”¨ï¼Œé˜²æ­¢OOMï¼Œå› æ­¤å¯ä»¥ç”¨APIæ¥å¯¹çº¿ç¨‹çš„ç”Ÿå‘½å‘¨æœŸè¿›è¡Œç®¡ç† 

ä¸‹é¢å°±ç®€å•ä»‹ç»ä¸‰ä¸ª

è€è§„çŸ©æ€»ç»“ï¼Œå¯ä»¥è‡ªå·±è¡¥å……å“ˆ

- **æ€»ç»“**

| Api         | ä»‹ç»                                                         |
| ----------- | ------------------------------------------------------------ |
| join()      | ç­‰å¾…å½“å‰è¿™ä¸ªtçº¿ç¨‹æ­»äº¡ï¼šå¦‚æœtæ²¡æœ‰æ‰§è¡Œå®Œæ¯•ï¼Œç¨‹åºçš„æ‰§è¡Œæµå°±ä¼šä¸€ç›´é˜»å¡åœ¨è¿™ä¸€è¡Œ |
| sleep()     | æš‚åœå½“å‰çº¿ç¨‹çš„æ‰§è¡Œ,è¿›å…¥è¶…æ—¶ç­‰å¾…çŠ¶æ€ï¼Œæ—¶é—´åˆ°åè‡ªåŠ¨å”¤é†’çº¿ç¨‹    |
| interrupt() | interrupt()å¹¶ä¸ä¼šå¼ºåˆ¶ä¸­æ–­çº¿ç¨‹ï¼Œå®ƒåªæ˜¯å‘å‡ºä¸€ä¸ªä¸­æ–­è¯·æ±‚ï¼Œç”±è¢«ä¸­æ–­çº¿ç¨‹æ¥å†³å®šæ˜¯å¦åº”è¯¥ä¸­æ–­ã€‚ è¢«ä¸­æ–­çº¿ç¨‹éœ€è¦æŒç»­æ£€æŸ¥æ˜¯å¦æ”¶åˆ°ä¸­æ–­è¯·æ±‚ï¼Œç¼–å†™ç›¸åº”é€»è¾‘è¿›è¡Œä¸­æ–­ã€‚ |

## 4.1 join()-ç­‰å¾…å½“å‰çº¿ç¨‹æ­»äº¡

~~~java
        Thread t = new Thread(new Task());
        t.start(); // éé˜»å¡æ€§æ–¹æ³•
        System.out.println("ä¸»çº¿ç¨‹æ‰§è¡Œå®Œæ¯•");
        t.join(); //ç­‰å¾…å½“å‰è¿™ä¸ªtçº¿ç¨‹æ­»äº¡ï¼šå¦‚æœtæ²¡æœ‰æ‰§è¡Œå®Œæ¯•ï¼Œç¨‹åºçš„æ‰§è¡Œæµå°±ä¼šä¸€ç›´é˜»å¡åœ¨è¿™ä¸€è¡Œ
        System.out.println("å­çº¿ç¨‹æ‰§è¡Œå®Œæ¯•");
~~~

## 4.2 sleep()-æš‚åœå½“å‰çº¿ç¨‹çš„æ‰§è¡Œ

~~~java
public static void main(String[] args) throws InterruptedException {
        for (int i = 0; i < 10; i++) {
            System.out.println(i);
            //æ¯éš”ä¸€ç§’é’Ÿè¿›è¡Œä¸€æ¬¡å¾ªç¯è¾“å‡º
            Thread.sleep(1000);//å•ä½ï¼šæ¯«ç§’
        }
    }
~~~

## 4.3 interrupt()-ä¸­æ–­

~~~java
public class InterruptMain {
    public static void main(String[] args) {
        Thread t = new Thread(new Task());
        t.start();
        System.out.println("ä¸»çº¿ç¨‹ç­‰å¾…ing...");
        RandomUtils.longSleep(2_000, 3_000);
        // å‘å‡ºä¸­æ–­çš„æŒ‡ä»¤
        System.out.println("å‘å‡ºä¸­æ–­æŒ‡ä»¤");
        t.interrupt(); // ä¸æ˜¯å¼ºåˆ¶æ€§çš„ï¼Œåªæ˜¯å‘å­çº¿ç¨‹å‘å‡ºäº†ä¸€ä¸ªä¸­æ–­ä¿¡å·
    }
private static class Task implements Runnable {
        @Override
        public void run() {
           for(int i=0;i<10_000;i++){
                if (isInterrupted()) return;
                System.out.println("å­çº¿ç¨‹æ‰§è¡Œing...");
            }
        }
        private boolean isInterrupted() {
            return Thread.currentThread().isInterrupted(); // å½“å‰çº¿ç¨‹æ˜¯å¦è¢«æ‰“äº†ä¸­æ–­çš„æ ‡è®°
        }
    }
~~~



# 5 çº¿ç¨‹å®‰å…¨

æˆ‘ä»¬ä½¿ç”¨å¤šçº¿ç¨‹ï¼Œéš¾å…å°±è¦è§£å†³å¹¶å‘ã€åŒæ­¥ç­‰é—®é¢˜ï¼Œå› æ­¤æˆ‘ä»¬å°±è¦ä½¿ç”¨æ‰‹æ®µæ¥è§£å†³è¿™ä¸ªéš¾ç‚¹

- çº¿ç¨‹å®‰å…¨ï¼šå½“å¤šä¸ªçº¿ç¨‹è®¿é—®ä¸€ä¸ªå¯¹è±¡ï¼Œå¦‚æœä¸éœ€è¦é¢å¤–çš„æ§åˆ¶ï¼Œè°ƒç”¨çš„æ‰¾ä¸ªå¯¹è±¡è¡Œä¸ºéƒ½æ˜¯æ­£ç¡®çš„ï¼Œé€šå¸¸å¯ä»¥è®¤ä¸ºæ˜¯çº¿ç¨‹å®‰å…¨çš„

![image-20220929104233173](images/image-20220929104233173.png)ï¼ˆçº¿ç¨‹å®‰å…¨å®ç°æ–¹æ³•)

åŒæ ·å…ˆ**æ€»ç»“**ï¼Œæœ‰å…´è¶£çœ‹ä½¿ç”¨

- **æ€»ç»“**

**æ­»é”ï¼š**è¿›ç¨‹Aä¸­åŒ…å«èµ„æºA,è¿›ç¨‹Bä¸­åŒ…å«èµ„æºBï¼ŒAçš„ä¸‹ä¸€æ­¥éœ€è¦èµ„æºBï¼ŒBçš„ä¸‹ä¸€æ­¥éœ€è¦èµ„æºAï¼Œæ‰€ä»¥å®ƒä»¬å°±äº’ç›¸ç­‰å¾…å¯¹æ–¹å æœ‰çš„èµ„æºé‡Šæ”¾ï¼Œæ‰€ä»¥ä¹Ÿå°±äº§ç”Ÿäº†ä¸€ä¸ªå¾ªç¯ç­‰å¾…æ­»é”ã€‚

- å¿…è¦æ¡ä»¶
  - äº’æ–¥æ¡ä»¶ï¼šèµ„æºä¸èƒ½è¢«å…±äº«ï¼Œåªèƒ½è¢«åŒä¸€ä¸ªè¿›ç¨‹ä½¿ç”¨
  - è¯·æ±‚ä¸ä¿æŒæ¡ä»¶ï¼šå·²ç»å¾—åˆ°èµ„æºçš„è¿›ç¨‹å¯ä»¥ç”³è¯·æ–°çš„èµ„æº
  - éå‰¥å¤ºæ¡ä»¶ï¼šå·²ç»åˆ†é…çš„èµ„æºä¸èƒ½ä»ç›¸åº”çš„è¿›ç¨‹ä¸­å¼ºåˆ¶å‰¥å¤º
  - å¾ªç¯ç­‰å¾…æ¡ä»¶ï¼šç³»ç»Ÿä¸­è‹¥å¹²è¿›ç¨‹å½¢æˆç¯è·¯ï¼Œè¯¥ç¯è·¯ä¸­æ¯ä¸ªè¿›ç¨‹éƒ½åœ¨ç­‰å¾…ç›¸é‚»è¿›ç¨‹å ç”¨çš„èµ„æº

**synchronizedï¼šåŒæ­¥é˜»å¡**

- ä»‹ç»ï¼šæ˜¯ä¸€ä¸ªå…³é”®å­—ï¼Œå±äºéå…¬å¹³é”ï¼Œå¯ä»¥ä¿®é¥°ä»£ç å—ã€æ–¹æ³•(ä¿®é¥°é™æ€æ–¹æ³•ç­‰äºç»™ç±»ä¸Šé”ï¼Œä¼šä½œâ½¤äºç±»çš„æ‰€æœ‰å¯¹è±¡å®ä¾‹ï¼›ä¿®é¥°å®ä¾‹æ–¹æ³•ç­‰äºç»™å¯¹è±¡ä¸Šé”)
- æ•ˆæœï¼šä¼šè®©è¯¥æ–¹æ³•å˜æˆåŸå­æ€§çš„ä¸€ä¸ªæ“ä½œ(ä¸èƒ½å†åˆ‡å‰²çš„)ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå½“ä¸€ä¸ªçº¿ç¨‹åœ¨é‡Œé¢æ‰§è¡Œï¼Œè¿˜æ²¡æœ‰æ‰§è¡Œå®Œæ¯•çš„æ—¶å€™ï¼Œå…¶å®ƒè¦è°ƒç”¨è¿™ä¸ªæ–¹æ³•çš„çº¿ç¨‹ä¼šä¸€ç›´è¢«é˜»å¡åœ¨å¤–é¢ 
- å·¥ä½œåŸç†ï¼Œå½“ä¸€ä¸ªæ–¹æ³•æˆ–ä»£ç å—è¢«synchronizeä¿®é¥°ï¼Œjvmå°±ä¼šåˆ›å»ºå‡ºä¸€ä¸ªç±»ä¼¼äºlockçš„å¯¹è±¡ï¼Œç§°ä¸ºmonitorï¼ˆç›‘è§†å™¨ï¼‰ï¼Œåªæœ‰çº¿ç¨‹è·å–åˆ°äº†ç›‘è§†å™¨ï¼Œæ‰èƒ½æ‰§è¡Œsynchronizeä¿®é¥°çš„æ–¹æ³•æˆ–ä»£ç å—ï¼Œæ‰§è¡Œå®Œåå†æŠŠç›‘è§†å™¨è¿”å›ç»™è°ƒåº¦å™¨

**ReentranLockï¼šåŒæ­¥é˜»å¡**

- æ¦‚å¿µï¼šå¯é‡å…¥é”æ˜¯æŒ‡æŸä¸ªçº¿ç¨‹åœ¨æœªé‡Šæ”¾å½“å‰é”çš„æƒ…å†µä¸‹ï¼Œå†æ¬¡è·å–è¯¥é”è€Œä¸ä¼šäº§ç”Ÿæ­»é”ï¼›
- è¡¨ç°å½¢å¼ï¼šå¯é‡å…¥é”åˆç§°ä¸ºé€’å½’é”ï¼Œæ„æ€æ˜¯å¦‚æœçº¿ç¨‹æºå¸¦å¤–å±‚æ–¹æ³•çš„é”ï¼Œè¿›å…¥åˆ°å†…å±‚æ–¹æ³•ä¸­ä¸ä¼šå› ä¸ºæ²¡æœ‰é‡Šæ”¾å¤–å±‚é”è€Œé˜»å¡ï¼Œè‡ªåŠ¨è·å–å†…å±‚æ–¹æ³•çš„é”ï¼›
- å®ç°æ–¹å¼ï¼šå…¬å¹³é”å’Œéå…¬å¹³é”ï¼ˆé»˜è®¤ä¸ºéå…¬å¹³é”ï¼Œç»™å‚æ•°fairè®¾ç½®trueæˆ–FALSEï¼‰

  - å…¬å¹³é”ï¼šå…¬å¹³é”æ˜¯æŒ‡å¤šä¸ªçº¿ç¨‹æ˜¯æ ¹æ®çº¿ç¨‹ç”³è¯·é”çš„é¡ºåºæ¥è·å–é”çš„ï¼Œç±»ä¼¼äºæ’é˜Ÿæ‰“é¥­ï¼Œå…ˆæ¥ååˆ°ï¼›

  - éå…¬å¹³é”ï¼šéå…¬å¹³é”æ˜¯æŒ‡å¤šä¸ªçº¿ç¨‹è·å–é”çš„é¡ºåºä¸æ˜¯æŒ‰ç…§ç”³è¯·é”çš„é¡ºåºï¼Œå¯èƒ½å‡ºç°åç”³è¯·çš„çº¿ç¨‹æ¯”å…ˆç”³è¯·çš„çº¿ç¨‹ä¼˜å…ˆè·å¾—é”çš„æƒ…å†µï¼Œåœ¨é«˜å¹¶å‘çš„æƒ…å†µä¸‹ï¼Œå¯èƒ½ä¼šå‡ºç°ä¼˜å…ˆçº§åè½¬æˆ–é¥¥é¥¿ç°è±¡ã€‚
- ä½œç”¨ï¼š
  - å¯é‡å…¥é”çš„ä¸»è¦ä½œç”¨å°±æ˜¯é¿å…æ­»é”ï¼šå‰ææ¡ä»¶æ˜¯æ²¡æœ‰newæ–°çš„lockå¯¹è±¡ï¼›ç”¨çš„éƒ½æ˜¯åŒä¸€æŠŠé”ï¼›
  - ç²¾ç¡®å”¤é†’çº¿ç¨‹ï¼šé€šè¿‡è®¾å®šæ¡ä»¶å˜é‡ï¼Œè°ƒç”¨awaitï¼ˆï¼‰å’Œsignalï¼ˆï¼‰æ–¹æ³•å¯¹çº¿ç¨‹æ‰§è¡Œçš„æ–¹æ³•è¿›è¡Œå”¤é†’å’Œé€šçŸ¥æ“ä½œï¼Œä»è€Œè¾¾åˆ°è®¾ç½®æ–¹æ³•æ‰§è¡Œé¡ºåºçš„ç›®çš„ï¼›

**CASï¼šåŒæ­¥ä¸é˜»å¡**

- ä»‹ç»ï¼šCASæœ‰ä¸‰ä¸ªæ“ä½œæ•°ï¼Œå†…å­˜åœ°å€ã€ æ—§çš„é¢„æœŸå€¼ã€ æ–°å€¼ï¼Œåªæœ‰å†…å­˜åœ°å€çš„å€¼ç­‰äºæ—§çš„é¢„æœŸå€¼ï¼Œæ‰èƒ½å§å†…å­˜åœ°å€çš„å€¼æ”¹ä¸ºæ–°å€¼
- ç¼ºç‚¹ï¼šç”¨ä¸Šé¢è¿™ç§æ–¹å¼ï¼Œä¼šæœ‰ABAé—®é¢˜
- è§£å†³ï¼šç”¨ç‰ˆæœ¬å·ä½œä¸ºæ›´æ–°çš„ä¾æ®ABAé—®é¢˜å°±ä¼šå˜æˆA(1)â€”B(2)â€”C(3)

**Volatileï¼š**

- å…³é”®å­—ï¼Œä¿®é¥°å˜é‡ï¼Œå‘Šè¯‰jvmè¿™æ˜¯ä¸€ä¸ªæ˜“å˜ã€ä¸ç¨³å®šçš„å˜é‡ï¼Œ ä¸éœ€è¦jitä¼˜åŒ–

- ä¿è¯äº†ä¸åŒçº¿ç¨‹å¯¹æŸä¸ªå˜é‡è¿›è¡Œæ“ä½œæ—¶çš„å¯è§æ€§ï¼Œå³ä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹äº†æŸä¸ªå˜é‡çš„å€¼ï¼Œè¿™ä¸ªå€¼å¯¹äºå…¶ä»–çº¿ç¨‹æ¥è¯´æ˜¯ç«‹å³å¯è§çš„ï¼›
- ç¦æ­¢æŒ‡ä»¤é‡æ’åºï¼šï¼ˆå£è¯€ï¼‰å†™é˜²ä¸‹ è¯»é˜²ä¸Šã€‚
- ä¸èƒ½ä¿è¯åŸå­æ€§

**ThreadLocalï¼š**

- ä»‹ç»ï¼šçº¿ç¨‹æœ¬åœ°å˜é‡ï¼Œï¼ˆJDK8ä»¥åï¼‰æ¯ä¸ªThreadç»´æŠ¤ä¸€ä¸ªThreadLocalMapå¯¹è±¡ï¼Œè¿™ä¸ªMapçš„keyæ˜¯ThreadLocalå®ä¾‹æœ¬èº«ï¼Œvalueæ˜¯å­˜å‚¨çš„å€¼è¦éš”ç¦»çš„å˜é‡ï¼Œæ˜¯æ³›å‹
- ThreadLocalçš„ç”Ÿå‘½å‘¨æœŸä¾èµ–äºThreadï¼Œæ‰€ä»¥ç”¨å®Œè¦åŠæ—¶è°ƒç”¨removeï¼ˆï¼‰ï¼Œä¸ç„¶ä¼šé€ æˆæ•°æ®è¯»å–æ··ä¹±ï¼ˆä¸Šè¯¾æ•°æ®åº“è¿æ¥æ—¶é‡åˆ°çš„é—®é¢˜ï¼‰ã€å†…å­˜æ³„æ¼
- çˆ¶çº¿ç¨‹çš„ThreadLocalä¼ é€’ç»™å­çº¿ç¨‹ï¼ˆé¢è¯•é—®åˆ°äº†ï¼‰
  - InheritableThreadLocal(çº¿ç¨‹æ± ä¸è¡Œï¼Œä¼šç¼“å­˜ä½¿ç”¨è¿‡çš„çº¿ç¨‹)

## 5.1 synchronized

~~~java
 public static void main(String[] args) throws InterruptedException {
        // 1ã€åˆ›å»ºä¸€ä¸ªè®¡æ•°å™¨å¯¹è±¡
        Counter counter = new Counter(); // è¢«äº‰æŠ¢çš„èµ„æºå¯¹è±¡
        // 2ã€åˆ›å»º2ä¸ªä»¥ä¸Šçš„çº¿ç¨‹ä»»åŠ¡ï¼Œå¯¹è®¡æ•°å™¨è¿›è¡Œç´¯åŠ 
        List<Thread> tasks = new ArrayList<>();
        for (int i = 0; i < 2; i++) {
            Thread t = new Thread(new User(counter));
            tasks.add(t);
            t.start();
        }
        // ç­‰å¾…ä»–ä»¬æ‰§è¡Œå®Œæ¯•
        for (Thread t : tasks)
            t.join();
        // 3ã€æœ€ç»ˆç»Ÿè®¡total
        System.out.println(counter.getTotal());

    }
private static class User implements Runnable {
        private Counter counter;
    
        public User(Counter counter) {
            this.counter = counter;
        }
        private void pushButton() {
            counter.increment();
        }
       @Override
        public void run() {
            for (int i = 0; i < 100_000; i++)
                pushButton();
        }
    }
~~~

- synchronizedéƒ¨åˆ†

~~~java
private static class Counter {
        // O
        private int total; // ä¸»å­˜åŒº CPUå¯„å­˜å™¨
        // private int total; // ä¸»å­˜åŒº CPUå¯„å­˜å™¨

    //ç”¨æ³•ä¸€ï¼Œsynchronizedå…³é”®å­—ä¿®é¥°æ–¹æ³•
        public synchronized void increment() { // ä¼šæœ‰å¤šä¸ªçº¿ç¨‹è½®ç•ªäº‰æŠ¢åˆ°æ—¶é—´ç‰‡è¿›æ¥æ‰§è¡Œç´¯åŠ é€»è¾‘
            // 1ã€æŠŠå¯„å­˜å™¨ä¸Šçš„totalç°åœ¨çš„å€¼æ‹·è´ä¸€ä»½è¿›æ¥ï¼Œå£°æ˜ä¸€ä¸ªå˜é‡å­˜èµ·æ¥
            // int temp = total;
            // 2ã€temp = temp + 1
            // 3ã€æŠŠç´¯åŠ åçš„tempå†™å›å¯„å­˜å™¨ä¸Šçš„totalå˜é‡
            // int num = 0; // å­˜å‚¨åœ¨å·¥ä½œå†…å­˜åŒº
            total++;
        }
    //ç”¨æ³•äºŒï¼Œsynchronizedä»£ç å—
     public void increment() {
        synchronized ( this) {	//éœ€è¦æä¾›ä¸€ä¸ªä¸å¯ä¿®æ”¹çš„å¼•ç”¨ç±»å‹çš„å˜é‡ï¼Œä¸€èˆ¬ä¸ä¼šä½¿ç”¨åŸºæœ¬ç±»å‹
            totalBytes++;
        }
    } 
        public int getTotal() {
            return total;
        }
    }
~~~

### 5.1.1  wait()ã€notify()ã€notifyAll()

- å¤§è‡´ç”¨æ³•

```java
  // è¦ä½¿ç”¨çº¿ç¨‹ä¹‹é—´é€šè®¯çš„æ–¹æ³•ï¼šçº¿ç¨‹1å‘Šè¯‰å¦å¤–ä¸€ä¸ªçº¿ç¨‹2ï¼Œæˆ‘çš„å·¥ä½œåšå®Œäº†
           Object lock = new Object();
           System.out.println(0);
           synchronized (lock) {
          //     // åšå®Œç¬¬ä¸€é˜¶æ®µçš„å·¥ä½œ
               lock.wait();  // å½“å‰çš„çº¿ç¨‹æš‚æ—¶äº¤å‡ºäº†CPUçš„æ—¶é—´ç‰‡ä½¿ç”¨æƒåŠ›ï¼Œæ­¤æ—¶ï¼Œæ­£å¸¸æƒ…å†µåº”è¯¥æœ‰å¦ä¸€ä¸ªçº¿ç¨‹æ¥å¾—åˆ°é” ç­‰åˆ°å¦ä¸€ä¸ªçº¿ç¨‹ä½¿ç”¨å®Œä»¥åï¼Œå†é€šçŸ¥â€œä½ åˆå¯ä»¥ç”¨äº†â€ lock.notifyAll()
          //     // åšç¬¬ä¸‰é˜¶æ®µçš„å·¥ä½œ
           }
           System.out.println(1);
  
           obj.notify(); // é€šçŸ¥1ä¸ªXXX
          // obj.notifyAll(); // é€šçŸ¥æ‰€æœ‰çš„XXX
```

  - å®ä¾‹

```java
  public class Main {
      // ä½ æ‹ä¸€ï¼Œæˆ‘æ‹ä¸€
      public static void main(String[] args) throws InterruptedException {
  
          // åˆ›å»ºä¸€ä¸ªç”¨æ¥äº‰æŠ¢çš„èµ„æº
          List<String> list = new ArrayList<>();
          // å¼€è¾Ÿä¸¤ä¸ªçº¿ç¨‹ï¼Œå¾€listä¸­å¡«å……æ•°æ®
          // å¡«å……çš„è§„åˆ™å¦‚ä¸‹ï¼šçº¿ç¨‹1é¦–å…ˆå¡«å……A,A,Aï¼Œç„¶åçº¿ç¨‹2å¡«å……B,B,Bï¼Œç„¶åçº¿ç¨‹1å†å¡«å……A,A,A
          // é—®é¢˜åˆ†æï¼š
          // å¯¹äºçº¿ç¨‹1æ¥è¯´ï¼Œå®ƒéœ€è¦å…ˆå¡«å……ä¸€äº›å­—ç¬¦ä¸²ï¼Œç„¶åç­‰å¾…ä¸€æ®µæ—¶é—´ï¼Œå†ç»§ç»­å®Œæˆåç»­çš„å¡«å……å·¥ä½œ
          // å¯¹äºçº¿ç¨‹2æ¥è¯´ï¼Œå®ƒéœ€è¦ç­‰åˆ°çº¿ç¨‹1å®Œæˆç¬¬ä¸€é˜¶æ®µçš„å·¥ä½œï¼Œå†å¡«å……è‡ªå·±çš„ä¿¡æ¯ï¼Œç„¶åå†äº¤å‡ºæ‰§è¡Œæƒ
  
  
          Thread t1 = new Thread(new WorkerA(list));
          Thread t2 = new Thread(new WorkerB(list));
  
          t1.start();
          RandomUtils.longSleep(100, 200);
  		t2.start();
          
          t1.join();
          t2.join(); // ç­‰2ä¸ªçº¿ç¨‹éƒ½ç»“æŸä»¥åå†æ¥æŸ¥çœ‹listä¸­çš„é¡ºåºæ˜¯å¦æ­£ç¡®
  
          System.out.println(list);
  
      }
  
      private static class WorkerA implements Runnable {
          final List<String> list;
  
          public WorkerA(List<String> list) {
              this.list = list;
          }
  
          public void fill() {
              for (int i = 0; i < 3; i++)
                  list.add("A");
          }
  
          @Override
          public void run() {
              // ä¸€å®šè¦è®°ä½ï¼Œåœ¨waitä¹‹å‰é¦–å…ˆå¿…é¡»å…ˆè·å–åˆ°monitor
              try {
                  synchronized (list) {
                      fill();
                      System.out.println("fill A 1");
                      list.wait();
                      fill();
                      System.out.println("fill A 2");
                  }
              } catch (InterruptedException e) {
                  throw new RuntimeException(e);
              }
          }
      }
  
      private static class WorkerB implements Runnable {
          final List<String> list;
  
          public void fill() {
              for (int i = 0; i < 3; i++)
                  list.add("B");
          }
  
          public WorkerB(List<String> list) {
              this.list = list;
          }
  
          @Override
          public void run() {
              synchronized (list) {
                  fill();
                  System.out.println("fill B");
                  list.notifyAll(); // å”¤é†’åˆ«äººæˆ‘åšå®Œäº†ï¼Œä½ ä»¬å¯ä»¥æ¥ç€å»æŠ¢äº†(monitor)
              }
          }
      }
  }
  
```

## 5.2 ReentrantLock()

~~~java
 Lock lock = new ReentrantLock(); // å¯é‡å…¥é”

public void increment() throws InterruptedException {
            //å‰é¢çš„é€»è¾‘ä»£ç 
    		//...............
            lock.lock(); // åŠ é”ï¼šä¸€æ—¦æ— æ³•è·å–åˆ°lockï¼Œåˆ™ä¼šé˜»å¡åœ¨æ­¤
            // boolean flag = lock.tryLock(3, TimeUnit.SECONDS); // éšç¼˜é”ï¼šï¼›ç«‹å³è¿”å›çš„ï¼Œtrue - æŠ¢åˆ°äº†ï¼›false - false
            // if (flag) {
            try {
                total++;
            } finally {
                lock.unlock(); // é‡Šæ”¾é”
            }
            // } else {
            //     // ç¼–å†™æ²¡æœ‰æŠ¢åˆ°è¡¥å¿é€»è¾‘
            // }
            //åé¢çš„é€»è¾‘ä»£ç 
    		//..............
 }
~~~

### 5.2.1 await()ã€signal()ã€signalAll()

~~~java
class ShareRes{
    private int num = 1; //A:1,B:2,C:3
    private ReentrantLock lock = new ReentrantLock();
    private Condition conditionA  = lock.newCondition();
    private Condition conditionB  = lock.newCondition();
    private Condition conditionC  = lock.newCondition();
    void print1(){
        lock.lock();
        try {
            while (num != 1){
                conditionA.await();
            }
            for (int i = 1; i <= 1; i++) {
                System.out.println(Thread.currentThread().getName()+"  "+i);
            }
            num = 2;
            conditionB.signal();
        }catch (Exception e){
            e.printStackTrace();
        }finally {
            lock.unlock();
        }
    }
    void print2(){
        lock.lock();
        try {
            while (num != 2){
                conditionB.await();
            }
            for (int i = 1; i <= 2; i++) {
                System.out.println(Thread.currentThread().getName()+"  "+i);
            }
            num = 3;
            conditionC.signal();
        }catch (Exception e){
            e.printStackTrace();
        }finally {
            lock.unlock();
        }
    }
    void print3(){
        lock.lock();
        try {
            while (num != 3){
                conditionC.await();
            }
            for (int i = 1; i <= 3; i++) {
                System.out.println(Thread.currentThread().getName()+"  "+i);
            }
            num = 1;
            conditionA.signal();
        }catch (Exception e){
            e.printStackTrace();
        }finally {
            lock.unlock();
        }
    } 
}
public class LockTraditionDemo {
    public static void main(String[] args) {
        final ShareRes res = new ShareRes();
        new Thread(new Runnable() {
            @Override
            public void run() {
                for (int i = 0; i < 3; i++) {
                    res.print1();
                }
            }
        },"çº¿ç¨‹A").start();
        new Thread(new Runnable() {
            @Override
            public void run() {
                for (int i = 0; i < 3; i++) {
                    res.print2();
                }
            }
        },"çº¿ç¨‹B").start();
        new Thread(new Runnable() {
            @Override
            public void run() {
                for (int i = 0; i < 3; i++) {
                    res.print3();
                }
            }
        },"çº¿ç¨‹C").start();
    }
}
 
----------------------------------
çº¿ç¨‹A  1
çº¿ç¨‹B  1
çº¿ç¨‹B  2
çº¿ç¨‹C  1
çº¿ç¨‹C  2
çº¿ç¨‹C  3
çº¿ç¨‹A  1
çº¿ç¨‹B  1
çº¿ç¨‹B  2
çº¿ç¨‹C  1
çº¿ç¨‹C  2
çº¿ç¨‹C  3
çº¿ç¨‹A  1
çº¿ç¨‹B  1
çº¿ç¨‹B  2
çº¿ç¨‹C  1
çº¿ç¨‹C  2
çº¿ç¨‹C  3
~~~

## 5.3 Volatile

- é—®é¢˜æ¡ˆä¾‹

```java
public class DownloadStatus {
    private int totalBytes;
    private boolean isDone;

    public synchronized void incrementTotalBytes() {
            totalBytes++;
    }

    public int getTotalBytes() {
        return totalBytes;
    }

    public boolean isDone() {
        return isDone;
    }

    public void setDone(boolean done) {
        isDone = done;
    }
}

public class DownloadFileTask implements Runnable {
    private DownloadStatus status;

    public DownloadFileTask(DownloadStatus status) {
        this.status = status;
    }

    @Override
    public void run() {
        System.out.println("Download:" + Thread.currentThread().getName());
        for (int i = 0; i < 1_000_000; i++) {
            if (Thread.currentThread().isInterrupted()) return;
            status.incrementTotalBytes();
        }
        status.setDone(true);
        System.out.println("Download complete:" + Thread.currentThread().getName());
    }
}

public class ThreadDemo {
    public static void main(String[] args) {
        var status = new DownloadStatus();
        var t1 = new Thread(new DownloadFileTask(status));
        t1.start();

        var t2 = new Thread(() -> {
            while (!status.isDone()) {
            }
            System.out.println(status.getTotalBytes());
        });
        t2.start();

    }
}
```

åœ¨è¿™ä¸ªæ¡ˆä¾‹ä¸­ï¼Œæˆ‘ä»¬ä¼šå‘ç°ç¨‹åºä¸€ç›´è¿è¡Œä¸èƒ½åœæ­¢ï¼Œä¸”`t2`çº¿ç¨‹æ— æ³•è¾“å‡ºæœ€ç»ˆç»“æœï¼Œä¸»è¦åŸå› åœ¨äºï¼š

- åœ¨è®¡ç®—æœºçš„`CPU`è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œå­˜åœ¨ä¸€å¥—ç¼“å­˜æœºåˆ¶ï¼šä¸ºäº†ä¼˜åŒ–ç¨‹åºæ‰§è¡Œé€Ÿåº¦ï¼Œä¼šé¦–å…ˆæŠŠä¸»å­˜å‚¨å™¨ï¼ˆ`main memory`ï¼‰ä¸­çš„æ•°æ®æ‹·è´åˆ°è‡ªå·±çš„ç¼“å­˜ï¼ˆ`cache`ï¼‰ä¸­ï¼Œç„¶åå†ç»§ç»­è¿ç®—ã€‚ç”±äºç›´æ¥ä»è‡ªå·±çš„`cache`ä¸­è¯»å–æ•°æ®çš„é€Ÿåº¦æ›´å¿«ï¼Œå› æ­¤å‡å°‘äº†ä¸æ–­ä¼ å€¼å¸¦æ¥çš„æ—¶é—´æŸè€—ã€‚
- `t1`çº¿ç¨‹å’Œ`t2`çº¿ç¨‹é¦–å…ˆéƒ½æŠŠè¿™ä¸ªå€¼æ‹·è´åˆ°è‡ªå·±çš„ç¼“å­˜ä¸­ï¼Œç„¶å`t1`çº¿ç¨‹å¯¹è¿™ä¸ªå€¼åšå‡ºäº†ä¿®æ”¹ï¼Œç”±äºç¼“å­˜ä¸­çš„æ•°æ®åªæœ‰è‡ªå·±å¯ä»¥è®¿é—®ï¼Œå› æ­¤`t2`çº¿ç¨‹å¹¶çœ‹ä¸åˆ°è¿™ä¸ªä¿®æ”¹ï¼Œç”šè‡³å½“`t1`çº¿ç¨‹å°†è¿™ä¸ªä¿®æ”¹å†™å›åˆ°ä¸»å­˜å‚¨å™¨ï¼Œè¿™ç§ä¿®æ”¹å¯¹äº`t2`ä»ç„¶æ˜¯ä¸å¯è§çš„ã€‚

è¿™ç§åœºæ™¯ï¼Œå°±ç§°ä¸ºå¤šçº¿ç¨‹å¹¶å‘çš„å¯è§æ€§é—®é¢˜ï¼š



![image-20210611030505411](images/image-20210611030505411.png)

- è§£å†³æ–¹æ³•ï¼švolatile

å½“`isDone`è¢«`volatile`ä¿®é¥°æ—¶ï¼Œæ„å‘³ç€å‘Šè¯‰`JVM`è¿™ä¸ªå˜é‡æ˜¯ä¸ç¨³å®šçš„ï¼Œä¸è¦åœ¨è®¡ç®—çš„æ—¶å€™ä¾èµ–å­˜å‚¨åœ¨ç¼“å­˜ä¸­çš„å€¼ï¼Œè€Œæ€»æ˜¯ä»ä¸»å­˜å‚¨å™¨ä¸­è¯»å–å®ƒï¼ŒåŒæ—¶ï¼Œå½“ä¸€ä¸ªçº¿ç¨‹ä¿®æ”¹`isDone`æ—¶ï¼Œä¼šç«‹åˆ»æ›´æ–°å­˜å‚¨åœ¨ä¸»å­˜å‚¨å™¨ä¸­çš„å€¼ã€‚

```java
public class DownloadStatus {
    private int totalBytes;
    private volatile boolean isDone;

    public synchronized void incrementTotalBytes() {
            totalBytes++;
    }

    public int getTotalBytes() {
        return totalBytes;
    }

    public boolean isDone() {
        return isDone;
    }

    public void setDone(boolean done) {
        isDone = done;
    }
}
```

## 5.4 ThreadLocal



# 6 çº¿ç¨‹å®‰å…¨å®ä¾‹ï¼šé¢åŒ…åº—é—®é¢˜(waitã€notify)

- é¢˜ç›®

~~~
1ã€è¯·å®šä¹‰ä¸€ä¸ªé¢åŒ…åº—å¯¹è±¡(åªæœ‰ä¸€ä¸ªå®ä¾‹)
-- ä½¿ç”¨æŸç§å›ºå®šçš„é¢‘ç‡æŒç»­çš„ç”Ÿäº§é¢åŒ…

2ã€è¯·å®šä¹‰ä¸€ä¸ªæ¶ˆè´¹è€…ç±»(å®ä¾‹æœ‰å¤šä¸ª)
-- å»é¢åŒ…åº—æ¶ˆè´¹(æŠ¢)é¢åŒ…ï¼Œæ¯æ¬¡æ¶ˆè´¹ä¸€ä¸ªï¼Œæ¶ˆè´¹çš„é€Ÿåº¦è‡ªå·±å®šä¹‰

3ã€ä¸æ–­çš„åœ¨æ§åˆ¶å°è¾“å‡ºï¼š
é¢åŒ…åº—ç”Ÿäº§äº†1ä¸ªé¢åŒ…ï¼Œç°æœ‰XXXä¸ª(å·²ç»æ¶ˆè´¹äº†XXXä¸ª)
æ¶ˆè´¹è€…æ¯æ¶ˆè´¹1ä¸ªé¢åŒ…ï¼Œä¹Ÿè¾“å‡ºJackä¹°åˆ°äº†1ä¸ªé¢åŒ…
~~~

- è‡ªå·±å†™çš„ï¼Œä¸çŸ¥é“åˆä¸åˆç†

~~~java
package bakeryquestion;

public class Test {
    public static void main(String[] args) {
        Bakery bakery = new Bakery();
        Thread t = new Thread(bakery);
        Thread t2 = new Thread(new Consumer(bakery,"Jack"));
        Thread t3 = new Thread(new Consumer(bakery,"Mike"));
        Thread t4 = new Thread(new Consumer(bakery,"Mary"));
        t.start();
        t2.start();
        t3.start();
        t4.start();
    }

    private static class Bakery implements Runnable {
        int count;

        @Override
        public void run() {
            System.out.println("Bakeryçº¿ç¨‹å¯åŠ¨");
            while (true) {
                //é¢åŒ…åº—100æ¯«ç§’æŠ¢ä¸€æ¬¡çº¿ç¨‹ï¼Œç”Ÿäº§é¢åŒ…
                try {
                    Thread.sleep(100);
                } catch (InterruptedException e) {
                    throw new RuntimeException(e);
                }

                synchronized (this) {

                    if (count <100) {
                        // é¢åŒ…è¶³å¤Ÿ

                        count++;
                        System.out.println("1ç”Ÿäº§äº†ä¸€ä¸ªé¢åŒ…ï¼Œæ€»å…±æœ‰" + count);
                        notifyAll();// ç”Ÿäº§äº†é¢åŒ…ï¼Œå‘Šè¯‰æ¶ˆè´¹è€…å¯ä»¥è´­ä¹°äº†

                    } else {
                        // é¢åŒ…ä¸å¤Ÿ
                        count++;
                        System.out.println("2ç”Ÿäº§äº†ä¸€ä¸ªé¢åŒ…ï¼Œæ€»å…±æœ‰" + count);
                        try {
                            wait();// ç”Ÿäº§äº†é¢åŒ…ï¼Œå‘Šè¯‰æ¶ˆè´¹è€…å¯ä»¥è´­ä¹°äº†
                        } catch (InterruptedException e) {
                            throw new RuntimeException(e);
                        }

                    }
                }

            }

        }
    }


    private static class Consumer implements Runnable {
        private Bakery bakery;
        String name;

        @Override
        public void run() {
            System.out.println("Consumerçº¿ç¨‹å¯åŠ¨");
            while (true) {
                //é¡¾å®¢500æ¯«ç§’æŠ¢ä¸€æ¬¡çº¿ç¨‹ï¼Œæ¶ˆè´¹é¢åŒ…
                try {
                    Thread.sleep(500);

                } catch (InterruptedException e) {
                    throw new RuntimeException(e);
                }

                synchronized (bakery) {
                    if (bakery.count > 0) {
                        System.out.println("é¡¾å®¢"+name+"ä¹°äº†ä¸€ä¸ªé¢åŒ…ï¼Œè¿˜å‰©");
                        bakery.count--;
                        bakery.notifyAll();// æ¶ˆè´¹å®Œäº†ä¸€ä¸ªé¢åŒ…ï¼Œç›¸å½“äºå‡å°‘ä¸€ä¸ªä¿¡å·é‡ï¼Œå‘Šè¯‰ç”Ÿäº§è€…è¦ç”Ÿäº§äº†
                    } else {
                        System.out.println("é¡¾å®¢"+name+"æƒ³ä¹°é¢åŒ…ï¼Œé¢åŒ…ä¸å¤Ÿ");
                        try {
                            bakery.wait();  // é¢åŒ…ä¸å¤Ÿï¼Œå‘Šè¯‰ç”Ÿäº§è€…è¦ç”Ÿäº§é¢åŒ…äº†
                        } catch (InterruptedException e) {
                            throw new RuntimeException(e);
                        }

                    }

                }

            }

        }

        public Consumer(Bakery bakery, String name) {
            this.bakery = bakery;
            this.name = name;
        }
    }


}

~~~








